version: '3.8'

services:
  multisig-service:
    build: .
    container_name: multisig-service
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - PORT=3001
      # Database
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=multisig_db
      - DB_USER=postgres
      - DB_PASSWORD=password
      # Blockchain
      - WEB3_PROVIDER_URL=http://ganache:7545
      - NETWORK_ID=5777
      # Service Discovery
      - EUREKA_HOST=discovery-service
      - EUREKA_PORT=9999
      # Optional deployer account (if not provided in requests)
      - DEPLOYER_ADDRESS=0x90F8bf6A479f320ead074411a4B0e7944Ea8c9C1
      - DEPLOYER_PRIVATE_KEY=4f3edf983ac636a65a842ce7c78d9aa706d3b113bce9c46f30d7d21715b23b1d
    volumes:
      - ./src:/app/src
      - ./contracts:/app/contracts
      - ./migrations:/app/migrations
    depends_on:
      - postgres
      - ganache
    networks:
      - app-network
      - blockchain-network

  postgres:
    image: postgres:15-alpine
    container_name: multisig-postgres
    environment:
      - POSTGRES_DB=multisig_db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - app-network

  ganache:
    image: trufflesuite/ganache:latest
    container_name: multisig-ganache
    ports:
      - "7545:7545"
    command: 
      - --server.host=0.0.0.0
      - --chain.networkId=5777
      - --wallet.deterministic=true
      - --wallet.totalAccounts=10
      - --chain.hardfork=london
      - --miner.blockTime=0
    networks:
      - blockchain-network

volumes:
  postgres_data:

networks:
  app-network:
    name: codespark-network
    external: true
  blockchain-network:
    driver: bridge